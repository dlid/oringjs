;new function(e){function n(e){return Array.prototype.slice.call(e)}function t(e){var n=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return n}function o(){return++c+""+(new Date).getTime()}function r(e){var n;if("string"==typeof e)try{n=JSON.parse(e)}catch(e){n=null}else"object"==typeof e&&(n=e);if("object"==typeof n){if(void 0!==n._d&&void 0!==n._t&&void 0!==n._w)var t=Object.create(h,{data:{value:n._d,enumerable:!1},type:{value:n._t},invocationId:{value:n._i?n._i:null}});return t}}function s(e,n,t){return Object.create(g,{type:{value:e},data:{value:n},created:{value:(new Date).getTime()},invocationId:{value:t||null}})}function a(e){function t(e,t){if(e.__proto__==h){var r,i,s=e.getData().methods,a={};if(!s)return null;var l;for(r=0;r<s.length;r++){if(-1===(l=s[r].n).indexOf("."))i=l,hub="*";else{var u=l.split(".");hub=u[0],i=u[1]}a[i]=function(e,r,i){return function(){console.warn("CALL",e,r);var s=null;return i&&(s=o()),t(e,r,s,n(arguments))}}(hub,i,s[r].r)}return a}return null}var i=["webSocket","longPolling"],a=l.extend({url:null,hubs:[],transferProtocols:i},e);e.transferProtocols&&(a.transferProtocols=e.transferProtocols),console.warn("SETTINGS",a);var c=function(e){var n=e.indexOf("?"),t=null;-1!=n&&(t=e.substring(n+1),e=e.substring(0,n));var o=e.match(/((?:http|ws|)s?:\/\/|^)([^:]+?)(?::(\d+)|$)/);if(o){var r=o[1],i=o[2],s=o[3]?o[3]:null;return{schema:r?r.replace(/:\/\/$/,""):"http",path:i,port:s,querystring:t}}}(e.url);this.start=function(){function e(){(i+=1)<p.length?((o=new p[i].class).onclose=function(){console.warn("Connection was lost")},o.start(c,a.hubs,{parseMessage:r}).done(function(e){var r=null;e.message&&(r=e.message),o.onmessage=function(e){if(f){if(console.warn("[incoming] ",e),void 0!==g[e.getType()])return void g[e.getType()]._def.resolve(e.getData())}else if("oring:handshake"==e.getType()){f=!0;var r=t(e,function(e,n,t,arguments){var r=l.Deferred(),i=s("oring:invoke",{hub:e,name:n,args:arguments},t);return t&&(g["oring:response__"+t]={_created:(new Date).getTime(),_def:r},console.warn("WOA! Listen for","oring:response__"+t)),o.send(i),t||r.resolve(),r.promise()});r&&(r.transferProtocol=p[i].name,n.resolve(r)),console.warn("handskahe complete")}else console.warn("Message received without handshake...",e)},console.warn("Alright, "+p[i].name+" succeeded"),r&&o.onmessage(r)}).fail(function(){console.warn("Noo, "+p[i].name+" failed"),e()})):(d("No protocol could connect ("+a.transferProtocols.join(",")+")"),n.reject())}var n=l.Deferred(),o=null,i=-1,f=!1,p=[],h=!1;for(i=0;i<a.transferProtocols.length;i++){for(h=!0,o=0;o<u.length;o++)if(a.transferProtocols[i]==u[o].name){p.push(u[o]),h=!1;break}h&&d("Unknown transferProtcol",a.transferProtocols[i])}i=-1,o=null;var g={};return e(),n.promise()},e.url||d("URL was not provided")}var l=this,u=[],c=-1;(function(e){e("object"==typeof exports?exports:this)}).call(this,function(e){var n=Array.prototype.slice,t=Array.prototype.forEach,o=function(e){if("object"!=typeof e)throw e+" is not an object";var r=n.call(arguments,1);return t.call(r,function(n){if(n)for(var t in n)"object"==typeof n[t]&&e[t]?o.call(e,e[t],n[t]):e[t]=n[t]}),e};e.extend=o}),function(e){function n(e){return"[object Array]"===Object.prototype.toString.call(e)}function t(e,t){if(n(e))for(var o=0;o<e.length;o++)t(e[o]);else t(e)}function o(e){var r="pending",i=[],s=[],a=[],l=null,u={done:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],o=0;o<t.length;o++)"resolved"===r&&t[o].apply(this,l),i.push(t[o]);else"resolved"===r&&arguments[e].apply(this,l),i.push(arguments[e]);return this},fail:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],o=0;o<t.length;o++)"rejected"===r&&t[o].apply(this,l),s.push(t[o]);else"rejected"===r&&arguments[e].apply(this,l),s.push(arguments[e]);return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],o=0;o<t.length;o++)"pending"===r&&a.push(t[o]);else"pending"===r&&a.push(arguments[e]);return this},then:function(){arguments.length>1&&arguments[1]&&this.fail(arguments[1]),arguments.length>0&&arguments[0]&&this.done(arguments[0]),arguments.length>2&&arguments[2]&&this.progress(arguments[2])},promise:function(e){if(null==e)return u;for(var n in u)e[n]=u[n];return e},state:function(){return r},debug:function(){console.log("[debug]",i,s,r)},isRejected:function(){return"rejected"===r},isResolved:function(){return"resolved"===r},pipe:function(e,n,r){return o(function(o){t(e,function(e){"function"==typeof e?c.done(function(){var n=e.apply(this,arguments);n&&"function"==typeof n?n.promise().then(o.resolve,o.reject,o.notify):o.resolve(n)}):c.done(o.resolve)}),t(n,function(e){"function"==typeof e?c.fail(function(){var n=e.apply(this,arguments);n&&"function"==typeof n?n.promise().then(o.resolve,o.reject,o.notify):o.reject(n)}):c.fail(o.reject)})}).promise()}},c={resolveWith:function(e){if("pending"===r){r="resolved";for(var n=l=arguments.length>1?arguments[1]:[],t=0;t<i.length;t++)i[t].apply(e,n)}return this},rejectWith:function(e){if("pending"===r){r="rejected";for(var n=l=arguments.length>1?arguments[1]:[],t=0;t<s.length;t++)s[t].apply(e,n)}return this},notifyWith:function(e){if("pending"===r)for(var n=l=arguments.length>1?arguments[1]:[],t=0;t<a.length;t++)a[t].apply(e,n);return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}},f=u.promise(c);return e&&e.apply(f,[f]),f}o.when=function(){if(arguments.length<2){var e=arguments.length?arguments[0]:void 0;return e&&"function"==typeof e.isResolved&&"function"==typeof e.isRejected?e.promise():o().resolve(e).promise()}return function(e){for(var n=o(),t=e.length,r=0,i=new Array(t),s=0;s<e.length;s++)!function(o){var s=null;e[o].done?e[o].done(function(){i[o]=arguments.length<2?arguments[0]:arguments,++r==t&&n.resolve.apply(n,i)}).fail(function(){n.reject(arguments)}):(s=e[o],e[o]=new Deferred,e[o].done(function(){i[o]=arguments.length<2?arguments[0]:arguments,++r==t&&n.resolve.apply(n,i)}).fail(function(){n.reject(arguments)}).resolve(s))}(s);return n.promise()}(arguments)},e.Deferred=o}(l);var f=function(e,n,o){var r=l.extend({method:"get",url:null,headers:{},data:null},e),s=p();s.open(r.method,r.url,!0);var a=null,u=t(r.headers);for(i=0;i<u.length;i+=1)s.setRequestHeader(u[i],r.headers[u[i]]);"post"==r.method.toLowerCase()&&(a=r.data),s.send(a),s.onreadystatechange=function(){4===s.readyState&&(200===s.status?n.call(null,s.responseText):o.call(null,s.responseText))}},p=function(){if(void 0!==typeof XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)for(var e=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"],n=0;n<e.length;n++)try{return new ActiveXObject(e[n])}catch(e){}};u.push({name:"longPolling",class:function(){var e,n,t,o=this;this.onclose=null,this.onmessage=null,this.send=function(r){r.__proto__==g?e&&(console.warn("queue message for polling",e,r),f({method:"post",url:n,headers:{"X-Oring-Request":e,"Content-Type":"application/json"},data:r.toJSON()},function(e){o.onmessage(t.parseMessage(e))},function(e){console.warn("FAILED",e)})):d("That's no request")},this.start=function(r,i,s){t=s;var a=l.Deferred(),u="";return u="https"==r.schema||"wss"==r.schema?"https://":"http://",u+=r.path,r.port&&(u+=":"+r.port),r.querystring&&(u+="?"+r.querystring),r.querystring?u+="&":u+="?",u+="__oringprotocol=longPolling",n=u,i&&i.length>0&&(r.querystring&&(u+="&"),u+="__oringhubs="+encodeURIComponent(i.join(","))),f({url:u},function(r){var i=t.parseMessage(r);i?i.data.id&&(e=i.data.id,a.resolve({message:i}),setInterval(function(){f({url:n+"&ping",headers:{"X-Oring-Request":e,"Content-Type":"application/json"}},function(e){var n;try{n=JSON.parse(e)}catch(e){}if("object"==typeof n&&n.length>0)for(var r=0;r<n.length;r+=1){var i=t.parseMessage(n[r]);i&&o.onmessage(i)}},function(){console.warn("longPolling ping failed...")})},1e4)):a.reject("Invalid message")},function(){a.reject()}),a.promise()}}});var h={data:null,sent:null,invocationId:null,type:null,getType:function(){return this.type},getData:function(){return this.data}},g={data:null,created:null,invocationId:null,type:null,getType:function(){return this.type},getData:function(){return this.data},getInvocationID:function(){return this._i},toJSON:function(){return JSON.stringify({_t:this.type,_d:this.data,_c:this.created,_i:this.invocationId})}},d=function(){if(console&&console.error){var e=n(arguments);e.unshift("[oring] "),console.error.apply(console,e)}},v=function(e,n){var t=l.extend({url:e,hubs:[]},n);return console.warn("options",t),new a(t)};u.push({name:"webSocket",class:function(){var e,n=this;this.onclose=null,this.onmessage=null,this.send=function(n){n.__proto__==g?e&&e.send(n.toJSON()):d("That's no request")},this.start=function(t,o,r){var i=l.Deferred(),s="";return s="https"==t.schema||"wss"==t.schema?"wss://":"ws://",s+=t.path,t.port&&(s+=":"+t.port),t.querystring&&(s+="?"+t.querystring),o&&o.length>0&&(t.querystring&&(s+="&"),s+="__oringhubs="+encodeURIComponent(o.join(","))),e=new WebSocket(s,"oringserver"),e.onopen=function(e){i.resolve({})},e.onclose=function(e){d("Connection closed",e),"function"==typeof n.onclose&&n.onclose()},e.onerror=function(e){i&&i.reject(e)},e.onmessage=function(e){e&&e.data&&n.onmessage(r.parseMessage(e.data))},i.promise()}}}),e.oring=new function(){this.create=function(){return v.apply(this,n(arguments))},this._core=l,console.warn("CORE",l)}(l)}(window);