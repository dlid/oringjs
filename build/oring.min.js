;new function(e){function n(e){return Array.prototype.slice.call(e)}function t(e){var n=[];for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&n.push(t);return n}function o(){return++w+""+(new Date).getTime()}function r(e){var n=document.createElement("a");return n.href=e,{schema:n.protocol,host:n.hostname,port:n.port,path:n.pathname,querystring:p(n.search)}}function s(){}function a(e,n){var t=m.extend({},e,n);return e.schema&&n.schema&&(u(e.schema)?t.schema=f(t.schema):t.schema=h(t.schema)),t}function l(e){var n="";if(e.schema&&(n=e.schema+"://"),e.host&&(n+=e.host),e.port&&(n+=":"+e.port),e.path&&(n+=e.path),e.querystring){for(var o=t(e.querystring),r=[],i=0;i<o.length;i+=1)r.push(encodeURIComponent(o[i])+"="+encodeURIComponent(e.querystring[o[i]]));r.length>0&&(n+="?"+r.join("&"))}return n}function u(e){return"https"==e||"wss"==e}function f(e){return u(e)?e:e+"s"}function h(e){return u(e)?e.substr(0,e.length-1):e}function p(e){var n,t,o,r={};if(e)for(t=(n=e.indexOf("?"))>-1?e.substr(n+1).split("&"):e.split("&"),n=0;n<t.length;n+=1)2==(o=t[n].split("=")).length&&(r[o[0]]=decodeURIComponent(o[1]));return r}function g(e){var n;if("string"==typeof e)try{n=JSON.parse(e)}catch(e){n=null}else"object"==typeof e&&(n=e);if(n&&"object"==typeof n){if(void 0!==n._d&&void 0!==n._t&&void 0!==n._w)var t=Object.create(b,{data:{value:n._d,enumerable:!1},type:{value:n._t},invocationId:{value:n._i?n._i:null}});return t}}function d(e,n,t){return Object.create(O,{type:{value:e},data:{value:n},created:{value:(new Date).getTime()},invocationId:{value:t||null}})}function v(e){function n(){function e(){(r+=1)<l.length?(t=new l[r].class(l[r].name)).start(h,a.hubs,{parseMessage:g}).done(function(e){t.onclose=function(){console.error("Connection was lost!!!! NOOOO!")},o&&console.warn("[OOAOAAO] An existing connection exists! MÖÖÖRGE!"),(o=Object.create(T)).start(t,function(e){n.resolve(e)}),e.message&&o.onmessage(e.message)}).fail(function(){console.warn("Noo, "+l[r].name+" failed"),e()}):(n.reject(),setTimeout(function(){n.reject()}))}var n=m.Deferred(),t=null,r=-1;return e(),n.promise()}var t,o,i=["webSocket","longPolling"],a=m.extend({url:null,hubs:[],transferProtocols:i},e),l=[],u=!1,f=!1;for(e.transferProtocols&&(a.transferProtocols=e.transferProtocols),t=0;t<a.transferProtocols.length;t++){for(u=!0,c=0;c<y.length;c++)if(a.transferProtocols[t]==y[c].name){l.push(y[c]),u=!1;break}u&&S("Unknown transferProtcol",a.transferProtocols[t])}console.warn("SETTINGS",a);var h=r(e.url);this.start=function(e){e=e,f=!0,s("Attempting to connect...");var t=function(){n().done(function(n){e(n)}).fail(function(){f&&(s("Could not connect. Waiting to retry..."),setTimeout(t,5e3))})};t()},this.stop=function(){o&&o.stop(),f=!1},e.url||S("URL was not provided")}var m=this,y=[],w=-1;window.parseQuerystring=p,window.parseUrl=r,window.combineUrl=a,function(e){e("object"==typeof exports?exports:this)}.call(this,function(e){var n=Array.prototype.slice,t=Array.prototype.forEach,o=function(e){if("object"!=typeof e)throw e+" is not an object";var r=n.call(arguments,1);return t.call(r,function(n){if(n)for(var t in n)"object"==typeof n[t]&&e[t]?o.call(e,e[t],n[t]):e[t]=n[t]}),e};e.extend=o}),function(e){function n(e){return"[object Array]"===Object.prototype.toString.call(e)}function t(e,t){if(n(e))for(var o=0;o<e.length;o++)t(e[o]);else t(e)}function o(e){var r="pending",i=[],s=[],a=[],c=null,l={done:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],o=0;o<t.length;o++)"resolved"===r&&t[o].apply(this,c),i.push(t[o]);else"resolved"===r&&arguments[e].apply(this,c),i.push(arguments[e]);return this},fail:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],o=0;o<t.length;o++)"rejected"===r&&t[o].apply(this,c),s.push(t[o]);else"rejected"===r&&arguments[e].apply(this,c),s.push(arguments[e]);return this},always:function(){return this.done.apply(this,arguments).fail.apply(this,arguments)},progress:function(){for(var e=0;e<arguments.length;e++)if(arguments[e])if(n(arguments[e]))for(var t=arguments[e],o=0;o<t.length;o++)"pending"===r&&a.push(t[o]);else"pending"===r&&a.push(arguments[e]);return this},then:function(){arguments.length>1&&arguments[1]&&this.fail(arguments[1]),arguments.length>0&&arguments[0]&&this.done(arguments[0]),arguments.length>2&&arguments[2]&&this.progress(arguments[2])},promise:function(e){if(null==e)return l;for(var n in l)e[n]=l[n];return e},state:function(){return r},debug:function(){console.log("[debug]",i,s,r)},isRejected:function(){return"rejected"===r},isResolved:function(){return"resolved"===r},pipe:function(e,n,r){return o(function(o){t(e,function(e){"function"==typeof e?u.done(function(){var n=e.apply(this,arguments);n&&"function"==typeof n?n.promise().then(o.resolve,o.reject,o.notify):o.resolve(n)}):u.done(o.resolve)}),t(n,function(e){"function"==typeof e?u.fail(function(){var n=e.apply(this,arguments);n&&"function"==typeof n?n.promise().then(o.resolve,o.reject,o.notify):o.reject(n)}):u.fail(o.reject)})}).promise()}},u={resolveWith:function(e){if("pending"===r){r="resolved";for(var n=c=arguments.length>1?arguments[1]:[],t=0;t<i.length;t++)i[t].apply(e,n)}return this},rejectWith:function(e){if("pending"===r){r="rejected";for(var n=c=arguments.length>1?arguments[1]:[],t=0;t<s.length;t++)s[t].apply(e,n)}return this},notifyWith:function(e){if("pending"===r)for(var n=c=arguments.length>1?arguments[1]:[],t=0;t<a.length;t++)a[t].apply(e,n);return this},resolve:function(){return this.resolveWith(this,arguments)},reject:function(){return this.rejectWith(this,arguments)},notify:function(){return this.notifyWith(this,arguments)}},f=l.promise(u);return e&&e.apply(f,[f]),f}o.when=function(){if(arguments.length<2){var e=arguments.length?arguments[0]:void 0;return e&&"function"==typeof e.isResolved&&"function"==typeof e.isRejected?e.promise():o().resolve(e).promise()}return function(e){for(var n=o(),t=e.length,r=0,i=new Array(t),s=0;s<e.length;s++)!function(o){var s=null;e[o].done?e[o].done(function(){i[o]=arguments.length<2?arguments[0]:arguments,++r==t&&n.resolve.apply(n,i)}).fail(function(){n.reject(arguments)}):(s=e[o],e[o]=new Deferred,e[o].done(function(){i[o]=arguments.length<2?arguments[0]:arguments,++r==t&&n.resolve.apply(n,i)}).fail(function(){n.reject(arguments)}).resolve(s))}(s);return n.promise()}(arguments)},e.Deferred=o}(m);var _=function(e,n,o){var r=m.extend({method:"get",url:null,headers:{},data:null},e),s=j();s.open(r.method,r.url,!0);var a=null,c=t(r.headers);for(i=0;i<c.length;i+=1)s.setRequestHeader(c[i],r.headers[c[i]]);"post"==r.method.toLowerCase()&&(a=r.data),s.send(a),s.onreadystatechange=function(){4===s.readyState&&(200===s.status?n.call(null,s.responseText):o.call(null,s.responseText))}},j=function(){if(void 0!==typeof XMLHttpRequest)return new XMLHttpRequest;if(window.ActiveXObject)for(var e=["MSXML2.XMLHttp.5.0","MSXML2.XMLHttp.4.0","MSXML2.XMLHttp.3.0","MSXML2.XMLHttp","Microsoft.XMLHttp"],n=0;n<e.length;n++)try{return new ActiveXObject(e[n])}catch(e){}};y.push({name:"longPolling",class:function(e){var n,t,o,r=this,i=null;this.name=e,this.onclose=null,this.onmessage=null,this.stop=function(){i&&(console.warn("Stopping poll timer"),clearTimeout(i))},this.send=function(e){e.__proto__==O?n&&(console.warn("queue message for polling",n,e),_({method:"post",url:t,headers:{"X-Oring-Request":n,"Content-Type":"application/json"},data:e.toJSON()},function(e){var n=o.parseMessage(e);n&&r.onmessage(n)},function(e){console.warn("FAILED",e)})):S("That's no request")},this.start=function(e,c,u){o=u;var f=m.Deferred(),h={__oringprotocol:"longPolling"};return t=l(a(e,{schema:"http",querystring:h})),c&&c.length>0&&(h.__oringhubs=encodeURIComponent(c.join(","))),url=l(a(e,{schema:"http",querystring:h})),_({url:url},function(e){var a=o.parseMessage(e),c=0;if(a){if(a.data.id){n=a.data.id;function l(){_({url:t+"&ping",headers:{"X-Oring-Request":n,"Content-Type":"application/json"}},function(e){var n;try{n=JSON.parse(e)}catch(e){}if(console.warn("POLL RECEIVED",e),"object"==typeof n&&n.length>=0){for(var t=0;t<n.length;t+=1){console.warn(" poll message ["+t+"]",n[t]);var a=o.parseMessage(n[t]);a&&(c=0,r.onmessage(a))}i=setTimeout(l,1e4)}else c>=3?"function"==typeof r.onclose&&"function"==typeof r.onopen&&(s("longPolling unexpected response (attempt "+c+")"),r.onclose()):c+=1},function(e){c>=3?"function"==typeof r.onclose&&r.onclose(e):(s("longPolling failed (attempt "+c+")"),c+=1)})}i=setTimeout(l,1e4),f.resolve({message:a})}}else f.reject("Invalid message")},function(){f.reject()}),f.promise()}}});var b={data:null,sent:null,invocationId:null,type:null,getType:function(){return this.type},getData:function(){return this.data}},O={data:null,created:null,invocationId:null,type:null,getType:function(){return this.type},getData:function(){return this.data},getInvocationID:function(){return this._i},toJSON:function(){return JSON.stringify({_t:this.type,_d:this.data,_c:this.created,_i:this.invocationId})}},T={c:null,id:null,_pr:{},handshakeComplete:!1,await:function(e,n){this._pr[e]=n},onmessage:function(e){this.c&&this.c.onmessage(e)},stop:function(){this.c&&this.c.stop()},start:function(e,n){var t,o=this,r=this._pr;this.c=e,e.onclose=function(){console.error(e.name,"closed")},e.onopen=function(){console.error(e.name,"opened")},e.onmessage=function(i){if(this.handshakeComplete)if("oring:reacquaint"==i.getType())console.error("WOA! SEND HANDSHAKE AGAIN!"),e.stop();else{if(void 0!==r[i.getType()])return void r[i.getType()]._def.resolve(i.getData());"oring:event"==i.getType()&&t&&t._triggerEvent(i.getData().name,i)}else"oring:handshake"==i.getType()?(t=Object.create(M)).setupContext(i,o)&&(this.handshakeComplete=!0,t.oring={transferProtocol:e.name},console.warn("CONTEXT IS SETUP",t),n(t)):console.warn("Message received without handshake...",i)}}},M={_eventhandlers:{},on:function(e,n){this._eventhandlers[e]||(this._eventhandlers[e]=[]),this._eventhandlers[e].push(n)},_triggerEvent:function(e,n){var t=this._eventhandlers[e];if(console.warn("TRIGGER",e,n),t)for(var o=0;o<t.length;o+=1)t[o](n.getData().eventData)},_invokeMethod:function(e,n,t,o,arguments){var r=m.Deferred(),i=(this._pr,d("oring:invoke",{hub:n,name:t,args:arguments},o));return o&&e.await("oring:response__"+o,{_created:(new Date).getTime(),_def:r}),e.c.send(i),o||r.resolve(),r.promise()},setupContext:function(e,t){var r=this._invokeMethod;if(e.__proto__==b){var i,s,a=e.getData().methods;if(!a)return!0;var c;for(i=0;i<a.length;i++){if(-1===(c=a[i].n).indexOf("."))s=c,hub="*";else{var l=c.split(".");hub=l[0],s=l[1]}var u=function(e,i,s){return function(){console.warn("CALL",e,i);var a=null;return s&&(a=o()),r(t,e,i,a,n(arguments))}}(hub,s,a[i].r);"*"!=hub?(this[hub]||(this[hub]={}),this[hub][s]=u):this[s]=u}return!0}}},S=function(){if(console&&console.error){var e=n(arguments);e.unshift("[oring] "),console.error.apply(console,e)}},s=function(){if(console&&console.log){var e=n(arguments);e.unshift("[oring] "),console.log.apply(console,e)}},C=function(e,n){var t=m.extend({url:e,hubs:[]},n);return console.warn("options",t),new v(t)};y.push({name:"webSocket",class:function(e){var n,t=this;this.name=e,this.onclose=null,this.onmessage=null,this.stop=function(){n&&(console.warn("CLOSE WEBSOCKET"),n.close())},this.send=function(e){e.__proto__==O?n&&n.send(e.toJSON()):S("That's no request")},this.start=function(e,o,r){var i=m.Deferred(),s={};return o&&o.length>0&&(s.__oringhubs=encodeURIComponent(o.join(","))),url=l(a(e,{schema:"ws",querystring:s})),n=new WebSocket(url,"oringserver"),n.onopen=function(e){"function"==typeof t.onopen&&t.onopen(),i.resolve({})},n.onclose=function(e){"function"==typeof t.onclose&&t.onclose(e)},n.onerror=function(e){i&&i.reject(e)},n.onmessage=function(e){e&&e.data&&t.onmessage(r.parseMessage(e.data))},i.promise()}}}),e.oring=new function(){this.create=function(){return C.apply(this,n(arguments))},this._core=m,console.warn("CORE",m)}(m)}(window);